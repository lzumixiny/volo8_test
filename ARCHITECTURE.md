# 智能锁检测系统 - 项目架构图

## 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                用户界面层                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                     │
│  │   钉钉群聊      │  │   API客户端     │  │   管理界面      │                     │
│  │                 │  │                 │  │                 │                     │
│  │  - @机器人       │  │  - REST API     │  │  - 统计面板      │                     │
│  │  - 图片发送      │  │  - 文件上传      │  │  - 配置管理      │                     │
│  │  - 结果查看      │  │  - 结果查询      │  │  - 日志查看      │                     │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                应用服务层                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                         FastAPI 应用                                         │   │
│  │                                                                             │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │   │
│  │  │   旧接口兼容     │  │   新API接口      │  │   钉钉集成      │           │   │
│  │  │                 │  │                 │  │                 │           │   │
│  │  │  - 对象检测      │  │  - 锁检测API     │  │  - 回调处理      │           │   │
│  │  │  - JSON返回      │  │  - 统计信息      │  │  - 消息发送      │           │   │
│  │  │  - 图片标注      │  │  - 历史记录      │  │  - 签名验证      │           │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                业务逻辑层                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   锁检测服务    │  │   钉钉服务      │  │   训练服务      │  │   数据管理      │ │
│  │                 │  │                 │  │                 │  │                 │ │
│  │  - 模型推理      │  │  - 消息解析      │  │  - 数据准备      │  │  - 数据存储      │ │
│  │  - 状态判断      │  │  - 图片下载      │  │  - 模型训练      │  │  - 历史查询      │ │
│  │  - 结果可视化    │  │  - 结果发送      │  │  - 性能评估      │  │  - 统计分析      │ │
│  │  - 特征分析      │  │  - 会话管理      │  │  - 模型管理      │  │  - 备份恢复      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                AI模型层                                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                           YOLOv8 模型                                         │   │
│  │                                                                             │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │   │
│  │  │   预训练模型    │  │   自定义模型    │  │   特征提取      │           │   │
│  │  │                 │  │                 │  │                 │           │   │
│  │  │  - yolov8n.pt   │  │  - lock_detector│  │  - 边界框检测    │           │   │
│  │  │  - 通用目标     │  │  - 专门训练     │  │  - 置信度计算    │           │   │
│  │  │  - 快速推理     │  │  - 高精度       │  │  - 类别分类      │           │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                数据存储层                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   SQLite数据库   │  │   文件系统      │  │   模型文件      │  │   日志文件      │ │
│  │                 │  │                 │  │                 │  │                 │ │
│  │  - 检测结果      │  │  - 数据集        │  │  - 训练模型      │  │  - 应用日志      │ │
│  │  - 锁详细信息    │  │  - 图片文件      │  │  - 权重文件      │  │  - 错误日志      │ │
│  │  - 训练记录      │  │  - 标注文件      │  │  - 配置文件      │  │  - 访问日志      │ │
│  │  - 统计信息      │  │  - 临时文件      │  │  - 导出模型      │  │  - 性能日志      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 锁检测详细流程

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              锁检测流程                                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  输入图片                                                                           │
│     │                                                                              │
│     ▼                                                                              │
│  ┌─────────────────┐                                                               │
│  │   图像预处理    │                                                               │
│  │                 │                                                               │
│  │  - 格式转换      │                                                               │
│  │  - 尺寸调整      │                                                               │
│  │  - 归一化        │                                                               │
│  └─────────────────┘                                                               │
│     │                                                                              │
│     ▼                                                                              │
│  ┌─────────────────┐                                                               │
│  │   YOLOv8推理    │                                                               │
│  │                 │                                                               │
│  │  - 目标检测      │                                                               │
│  │  - 边界框预测    │                                                               │
│  │  - 置信度计算    │                                                               │
│  │  - 类别分类      │                                                               │
│  └─────────────────┘                                                               │
│     │                                                                              │
│     ▼                                                                              │
│  ┌─────────────────┐                                                               │
│  │   结果解析      │                                                               │
│  │                 │                                                               │
│  │  - 过滤低置信度  │                                                               │
│  │  - 非极大值抑制  │                                                               │
│  │  - 结果排序      │                                                               │
│  └─────────────────┘                                                               │
│     │                                                                              │
│     ▼                                                                              │
│  ┌─────────────────┐                                                               │
│  │   锁状态判断    │                                                               │
│  │                 │                                                               │
│  │  - 类别判断      │  ┌─────────────────┐                                       │
│  │  - 特征分析      │  │   特征分析      │                                       │
│  │  - 图像处理      │  │                 │                                       │
│  └─────────────────┘  │  - 亮度分析      │                                       │
│     │              │  │  - 边缘检测      │                                       │
│     ▼              │  │  - 纹理分析      │                                       │
│  ┌─────────────────┐  │  └─────────────────┘                                       │
│  │   结果生成      │                                                               │
│  │                 │                                                               │
│  │  - 安全状态      │                                                               │
│  │  - 锁统计        │                                                               │
│  │  - 详细信息      │                                                               │
│  └─────────────────┘                                                               │
│     │                                                                              │
│     ▼                                                                              │
│  ┌─────────────────┐                                                               │
│  │   结果可视化    │                                                               │
│  │                 │                                                               │
│  │  - 边界框绘制    │                                                               │
│  │  - 标签添加      │                                                               │
│  │  - 状态标识      │                                                               │
│  │  - 颜色区分      │                                                               │
│  └─────────────────┘                                                               │
│     │                                                                              │
│     ▼                                                                              │
│  输出结果                                                                           │
│     ├─ JSON格式结果                                                                  │
│     ├─ 标注图片                                                                      │
│     └─ 统计信息                                                                      │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 钉钉集成架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              钉钉集成流程                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  钉钉群聊                                                                           │
│     │                                                                              │
│     ▼                                                                              │
│  ┌─────────────────┐                                                               │
│  │   用户@机器人   │                                                               │
│  │                 │                                                               │
│  │  - 发送图片      │                                                               │
│  │  - 文字描述      │                                                               │
│  │  - @触发        │                                                               │
│  └─────────────────┘                                                               │
│     │                                                                              │
│     ▼                                                                              │
│  ┌─────────────────┐                                                               │
│  │   钉钉服务器    │                                                               │
│  │                 │                                                               │
│  │  - 消息接收      │                                                               │
│  │  - 回调发送      │                                                               │
│  │  - 签名生成      │                                                               │
│  └─────────────────┘                                                               │
│     │                                                                              │
│     ▼                                                                              │
│  ┌─────────────────┐                                                               │
│  │   Webhook接口   │                                                               │
│  │                 │                                                               │
│  │  - 签名验证      │                                                               │
│  │  - 消息解析      │                                                               │
│  │  - @识别        │                                                               │
│  │  - 图片提取      │                                                               │
│  └─────────────────┘                                                               │
│     │                                                                              │
│     ▼                                                                              │
│  ┌─────────────────┐                                                               │
│  │   图片下载      │                                                               │
│  │                 │                                                               │
│  │  - 异步下载      │                                                               │
│  │  - 格式转换      │                                                               │
│  │  - 错误处理      │                                                               │
│  └─────────────────┘                                                               │
│     │                                                                              │
│     ▼                                                                              │
│  ┌─────────────────┐                                                               │
│  │   锁检测处理    │                                                               │
│  │                 │                                                               │
│  │  - 调用检测API    │                                                               │
│  │  - 生成结果      │                                                               │
│  │  - 数据存储      │                                                               │
│  └─────────────────┘                                                               │
│     │                                                                              │
│     ▼                                                                              │
│  ┌─────────────────┐                                                               │
│  │   结果格式化    │                                                               │
│  │                 │                                                               │
│  │  - Markdown格式  │                                                               │
│  │  - 图片嵌入      │                                                               │
│  │  - 状态标识      │                                                               │
│  └─────────────────┘                                                               │
│     │                                                                              │
│     ▼                                                                              │
│  ┌─────────────────┐                                                               │
│  │   消息发送      │                                                               │
│  │                 │                                                               │
│  │  - 钉钉API       │                                                               │
│  │  - Webhook发送   │                                                               │
│  │  - 结果展示      │                                                               │
│  └─────────────────┘                                                               │
│     │                                                                              │
│     ▼                                                                              │
│  钉钉群聊显示结果                                                                   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 数据库架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              数据库架构                                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  detection_results (检测结果主表)                                                    │
│  ┌─────────────────┬─────────────┬─────────────────────────────────────────────────┐ │
│  │      字段       │     类型    │                    描述                      │ │
│  ├─────────────────┼─────────────┼─────────────────────────────────────────────────┤ │
│  │ id              │ INTEGER     │ 主键，自增                                    │ │
│  │ image_url       │ TEXT        │ 图片URL                                      │ │
│  │ image_hash      │ TEXT        │ 图片哈希，唯一                                │ │
│  │ detection_time  │ DATETIME    │ 检测时间                                      │ │
│  │ locks_detected  │ INTEGER     │ 检测到的锁数量                                │ │
│  │ unlocked_locks  │ INTEGER     │ 未锁的锁数量                                  │ │
│  │ lock_positions  │ TEXT        │ 锁位置信息(JSON格式)                          │ │
│  │ confidence_score│ REAL        │ 置信度                                        │ │
│  │ dingtalk_msg_id │ TEXT        │ 钉钉消息ID                                    │ │
│  │ user_id         │ TEXT        │ 用户ID                                        │ │
│  │ group_id        │ TEXT        │ 群组ID                                        │ │
│  │ is_safe         │ BOOLEAN     │ 是否安全                                      │ │
│  │ created_at      │ DATETIME    │ 创建时间                                      │ │
│  └─────────────────┴─────────────┴─────────────────────────────────────────────────┘ │
│                                        │                                            │
│                                        ▼                                            │
│  lock_details (锁详细信息表)                                                        │
│  ┌─────────────────┬─────────────┬─────────────────────────────────────────────────┐ │
│  │      字段       │     类型    │                    描述                      │ │
│  ├─────────────────┼─────────────┼─────────────────────────────────────────────────┤ │
│  │ id              │ INTEGER     │ 主键，自增                                    │ │
│  │ detection_id    │ INTEGER     │ 外键，关联detection_results.id                 │ │
│  │ lock_type       │ TEXT        │ 锁类型                                        │ │
│  │ is_locked       │ BOOLEAN     │ 是否锁定                                      │ │
│  │ confidence      │ REAL        │ 置信度                                        │ │
│  │ position_x      │ INTEGER     │ X坐标                                        │ │
│  │ position_y      │ INTEGER     │ Y坐标                                        │ │
│  │ width           │ INTEGER     │ 宽度                                          │ │
│  │ height          │ INTEGER     │ 高度                                          │ │
│  └─────────────────┴─────────────┴─────────────────────────────────────────────────┘ │
│                                        │                                            │
│                                        ▼                                            │
│  training_records (训练记录表)                                                        │
│  ┌─────────────────┬─────────────┬─────────────────────────────────────────────────┐ │
│  │      字段       │     类型    │                    描述                      │ │
│  ├─────────────────┼─────────────┼─────────────────────────────────────────────────┤ │
│  │ id              │ INTEGER     │ 主键，自增                                    │ │
│  │ model_name      │ TEXT        │ 模型名称                                      │ │
│  │ training_start  │ DATETIME    │ 训练开始时间                                  │ │
│  │ training_end    │ DATETIME    │ 训练结束时间                                  │ │
│  │ epochs          │ INTEGER     │ 训练轮数                                      │ │
│  │ batch_size      │ INTEGER     │ 批次大小                                      │ │
│  │ learning_rate   │ REAL        │ 学习率                                        │ │
│  │ train_loss      │ REAL        │ 训练损失                                      │ │
│  │ val_loss        │ REAL        │ 验证损失                                      │ │
│  │ map_score       │ REAL        │ mAP分数                                       │ │
│  │ model_path      │ TEXT        │ 模型路径                                      │ │
│  │ dataset_size    │ INTEGER     │ 数据集大小                                    │ │
│  │ status          │ TEXT        │ 状态                                          │ │
│  │ created_at      │ DATETIME    │ 创建时间                                      │ │
│  └─────────────────┴─────────────┴─────────────────────────────────────────────────┘ │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 部署架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              部署架构                                             │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                           负载均衡器                                        │   │
│  │                                                                             │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │   │
│  │  │   Nginx         │  │   SSL终端       │  │   路由规则      │           │   │
│  │  │                 │  │                 │  │                 │           │   │
│  │  │  - 反向代理      │  │  - HTTPS        │  │  - API路由      │           │   │
│  │  │  - 负载均衡      │  │  - 证书管理      │  │  - 静态文件     │           │   │
│  │  │  - 缓存          │  │  - 安全策略      │  │  - 限流控制      │           │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                            │
│                                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                           应用服务器集群                                      │   │
│  │                                                                             │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │   │
│  │  │   Server 1      │  │   Server 2      │  │   Server N      │           │   │
│  │  │                 │  │                 │  │                 │           │   │
│  │  │  - FastAPI      │  │  - FastAPI      │  │  - FastAPI      │           │   │
│  │  │  - UVicorn      │  │  - UVicorn      │  │  - UVicorn      │           │   │
│  │  │  - 应用逻辑      │  │  - 应用逻辑      │  │  - 应用逻辑      │           │   │
│  │  │  - AI模型       │  │  - AI模型       │  │  - AI模型       │           │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                            │
│                                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                           数据存储层                                        │   │
│  │                                                                             │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │   │
│  │  │   主数据库      │  │   只读副本      │  │   文件存储      │           │   │
│  │  │                 │  │                 │  │                 │           │   │
│  │  │  - SQLite       │  │  - SQLite       │  │  - 模型文件      │           │   │
│  │  │  - 主从复制      │  │  - 读负载均衡    │  │  - 数据集        │           │   │
│  │  │  - 自动备份      │  │  - 高可用        │  │  - 图片文件      │           │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                            │
│                                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                           监控与日志                                         │   │
│  │                                                                             │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │   │
│  │  │   Prometheus    │  │   Grafana       │  │   ELK Stack     │           │   │
│  │  │                 │  │                 │  │                 │           │   │
│  │  │  - 指标收集      │  │  - 可视化        │  │  - 日志收集      │           │   │
│  │  │  - 告警规则      │  │  - 仪表板        │  │  - 日志分析      │           │   │
│  │  │  - 性能监控      │  │  - 报表生成      │  │  - 错误追踪      │           │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 安全架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              安全架构                                             │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                           网络安全层                                        │   │
│  │                                                                             │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │   │
│  │  │   防火墙        │  │   DDoS防护      │  │   VPN接入       │           │   │
│  │  │                 │  │                 │  │                 │           │   │
│  │  │  - 端口过滤      │  │  - 流量清洗      │  │  - 加密通道      │           │   │
│  │  │  - IP白名单      │  │  - 频率限制      │  │  - 双因素认证    │           │   │
│  │  │  - 入侵检测      │  │  - 异常流量      │  │  - 访问控制      │           │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                            │
│                                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                           应用安全层                                        │   │
│  │                                                                             │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │   │
│  │  │   API安全       │  │   数据验证      │  │   会话管理      │           │   │
│  │  │                 │  │                 │  │                 │           │   │
│  │  │  - JWT令牌      │  │  - 输入验证      │  │  - 会话超时      │           │   │
│  │  │  - OAuth2.0      │  │  - SQL注入防护   │  │  - 并发控制      │           │   │
│  │  │  - 权限控制      │  │  - XSS防护       │  │  - 状态管理      │           │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                            │
│                                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                           数据安全层                                        │   │
│  │                                                                             │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │   │
│  │  │   数据加密      │  │   访问控制      │  │   备份恢复      │           │   │
│  │  │                 │  │                 │  │                 │           │   │
│  │  │  - 传输加密      │  │  - 角色权限      │  │  - 定期备份      │           │   │
│  │  │  - 存储加密      │  │  - 数据脱敏      │  │  - 增量备份      │           │   │
│  │  │  - 密钥管理      │  │  - 审计日志      │  │  - 灾难恢复      │           │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```