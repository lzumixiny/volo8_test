# æ™ºèƒ½é”æ£€æµ‹ç³»ç»Ÿ - APIæ–‡æ¡£

## æ¦‚è¿°

æ™ºèƒ½é”æ£€æµ‹ç³»ç»Ÿæ˜¯åŸºäºYOLOv8çš„é”çŠ¶æ€è¯†åˆ«APIï¼Œæ”¯æŒé’‰é’‰æœºå™¨äººå›è°ƒã€å›¾ç‰‡æ£€æµ‹ã€æ¨¡å‹è®­ç»ƒç­‰åŠŸèƒ½ã€‚è¯¥ç³»ç»Ÿå¯ä»¥è‡ªåŠ¨æ£€æµ‹å›¾ç‰‡ä¸­çš„é”ï¼Œåˆ¤æ–­é”æ˜¯å¦æ­£å¸¸é”å®šï¼Œå¹¶é€šè¿‡é’‰é’‰æœºå™¨äººå‘é€æ£€æµ‹ç»“æœã€‚

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é’‰é’‰ç¾¤èŠ      â”‚    â”‚   FastAPI      â”‚    â”‚   æ•°æ®åº“        â”‚
â”‚                 â”‚â—„â”€â”€â–ºâ”‚   æœåŠ¡         â”‚â—„â”€â”€â–ºâ”‚   (SQLite)     â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚  @æœºå™¨äººå‘é€     â”‚    â”‚  - é”æ£€æµ‹API    â”‚    â”‚  - æ£€æµ‹ç»“æœ     â”‚
â”‚  å›¾ç‰‡           â”‚    â”‚  - é’‰é’‰å›è°ƒ     â”‚    â”‚  - è®­ç»ƒè®°å½•     â”‚
â”‚                 â”‚    â”‚  - æ¨¡å‹è®­ç»ƒ     â”‚    â”‚  - ç»Ÿè®¡ä¿¡æ¯     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   YOLOv8       â”‚
                       â”‚   æ¨¡å‹         â”‚
                       â”‚                 â”‚
                       â”‚  - é”æ£€æµ‹       â”‚
                       â”‚  - çŠ¶æ€åˆ¤æ–­     â”‚
                       â”‚  - å¯è§†åŒ–       â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æŠ€æœ¯æ ˆ

- **åç«¯æ¡†æ¶**: FastAPI
- **æœºå™¨å­¦ä¹ **: YOLOv8 (Ultralytics)
- **æ•°æ®åº“**: SQLite
- **å›¾åƒå¤„ç†**: PIL, scikit-image
- **å¼‚æ­¥å¤„ç†**: aiohttp
- **æ—¥å¿—ç³»ç»Ÿ**: loguru
- **æ•°æ®éªŒè¯**: Pydantic

## APIæ¥å£

### 1. é”æ£€æµ‹æ¥å£

#### POST /api/v1/lock/detect

æ£€æµ‹å›¾ç‰‡ä¸­çš„é”çŠ¶æ€

**è¯·æ±‚å‚æ•°:**
- `file`: å›¾ç‰‡æ–‡ä»¶ (å¿…éœ€)
- `user_id`: ç”¨æˆ·ID (å¯é€‰)

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "message": "æ£€æµ‹å®Œæˆ",
  "data": {
    "detection_id": 1,
    "result": {
      "is_safe": false,
      "total_locks": 3,
      "unlocked_locks": 1,
      "locked_locks": 2,
      "lock_details": [
        {
          "lock_type": "unlocked_lock",
          "is_locked": false,
          "confidence": 0.95,
          "bbox": {
            "xmin": 100,
            "ymin": 200,
            "xmax": 300,
            "ymax": 400
          }
        }
      ],
      "confidence_score": 0.95,
      "detection_time": "2025-09-04T10:30:00"
    },
    "image_base64": "base64ç¼–ç çš„æ£€æµ‹ç»“æœå›¾ç‰‡"
  }
}
```

### 2. é’‰é’‰é…ç½®æ¥å£

#### POST /api/v1/dingtalk/configure

é…ç½®é’‰é’‰æœºå™¨äºº

**è¯·æ±‚å‚æ•°:**
```json
{
  "app_key": "your_app_key",
  "app_secret": "your_app_secret",
  "webhook_url": "https://oapi.dingtalk.com/robot/send?access_token=xxx"
}
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "message": "é’‰é’‰é…ç½®æˆåŠŸ"
}
```

### 3. é’‰é’‰å›è°ƒæ¥å£

#### POST /api/v1/dingtalk/webhook

é’‰é’‰æœºå™¨äººå›è°ƒæ¥å£ï¼Œå¤„ç†ç¾¤èŠä¸­çš„@æ¶ˆæ¯

**è¯·æ±‚å¤´:**
- `timestamp`: æ—¶é—´æˆ³
- `sign`: ç­¾å

**è¯·æ±‚ä½“:** é’‰é’‰å›è°ƒæ¶ˆæ¯æ ¼å¼

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "message": "å¤„ç†æˆåŠŸ"
}
```

### 4. æ¨¡å‹è®­ç»ƒæ¥å£

#### POST /api/v1/train/start

å¯åŠ¨æ¨¡å‹è®­ç»ƒä»»åŠ¡

**è¯·æ±‚å‚æ•°:**
```json
{
  "model_name": "lock_detector",
  "epochs": 100,
  "batch_size": 16,
  "img_size": 640,
  "learning_rate": 0.001,
  "device": "auto"
}
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "message": "è®­ç»ƒä»»åŠ¡å·²å¯åŠ¨",
  "data": {
    "model_name": "lock_detector"
  }
}
```

### 5. ç»Ÿè®¡ä¿¡æ¯æ¥å£

#### GET /api/v1/stats

è·å–ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "message": "è·å–ç»Ÿè®¡ä¿¡æ¯æˆåŠŸ",
  "data": {
    "detection_stats": {
      "total_detections": 100,
      "unsafe_detections": 5,
      "total_locks": 250,
      "total_unlocked": 8,
      "today_detections": 10,
      "safety_rate": 95.0
    },
    "dataset_stats": {
      "train": {
        "images": 800,
        "labels": 800,
        "path": "dataset/train/images"
      },
      "val": {
        "images": 100,
        "labels": 100,
        "path": "dataset/val/images"
      },
      "test": {
        "images": 100,
        "labels": 100,
        "path": "dataset/test/images"
      }
    }
  }
}
```

### 6. æ£€æµ‹å†å²æ¥å£

#### GET /api/v1/history

è·å–æ£€æµ‹å†å²è®°å½•

**è¯·æ±‚å‚æ•°:**
- `limit`: é™åˆ¶æ•°é‡ (é»˜è®¤: 10)
- `offset`: åç§»é‡ (é»˜è®¤: 0)

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "message": "è·å–æ£€æµ‹å†å²æˆåŠŸ",
  "data": {
    "history": [
      {
        "id": 1,
        "image_url": "",
        "image_hash": "abc123",
        "detection_time": "2025-09-04T10:30:00",
        "locks_detected": 3,
        "unlocked_locks": 1,
        "lock_positions": [...],
        "confidence_score": 0.95,
        "is_safe": false,
        "created_at": "2025-09-04T10:30:00"
      }
    ]
  }
}
```

### 7. å¥åº·æ£€æŸ¥æ¥å£

#### GET /api/v1/health

ç³»ç»Ÿå¥åº·æ£€æŸ¥

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "message": "ç³»ç»Ÿæ­£å¸¸è¿è¡Œ",
  "data": {
    "database": "connected",
    "model_loaded": true,
    "total_detections": 100
  }
}
```

## å…¼å®¹çš„æ—§æ¥å£

ç³»ç»Ÿä¿ç•™äº†åŸæœ‰çš„å¯¹è±¡æ£€æµ‹æ¥å£ï¼Œç¡®ä¿å‘åå…¼å®¹ï¼š

### POST /img_object_detection_to_json

ä»å›¾åƒä¸­è¿›è¡Œå¯¹è±¡æ£€æµ‹å¹¶è¿”å›JSONç»“æœ

### POST /img_object_detection_to_img

ä»å›¾åƒä¸­è¿›è¡Œå¯¹è±¡æ£€æµ‹å¹¶åœ¨å›¾åƒä¸Šç»˜åˆ¶è¾¹ç•Œæ¡†

## é”™è¯¯å¤„ç†

æ‰€æœ‰æ¥å£éƒ½éµå¾ªç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼ï¼š

```json
{
  "success": false,
  "message": "é”™è¯¯æè¿°"
}
```

## é’‰é’‰æœºå™¨äººä½¿ç”¨è¯´æ˜

### 1. é…ç½®é’‰é’‰æœºå™¨äºº

1. åœ¨é’‰é’‰ç¾¤ä¸­æ·»åŠ è‡ªå®šä¹‰æœºå™¨äºº
2. è·å– `app_key` å’Œ `app_secret`
3. è°ƒç”¨ `/api/v1/dingtalk/configure` æ¥å£é…ç½®

### 2. ä½¿ç”¨æ–¹æ³•

åœ¨ç¾¤èŠä¸­@æœºå™¨äººå¹¶å‘é€åŒ…å«é”çš„å›¾ç‰‡ï¼š

```
@é”æ£€æµ‹æœºå™¨äºº [å›¾ç‰‡]
```

ç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
1. è¯†åˆ«@æ¶ˆæ¯
2. ä¸‹è½½å›¾ç‰‡
3. æ£€æµ‹é”çŠ¶æ€
4. å‘é€æ£€æµ‹ç»“æœ

### 3. æ£€æµ‹ç»“æœç¤ºä¾‹

**å®‰å…¨çŠ¶æ€:**
```
âœ… æ£€æµ‹å®Œæˆ - ä¸€åˆ‡æ­£å¸¸ï¼

ğŸ“Š æ£€æµ‹ç»“æœ:
- æ€»è®¡æ£€æµ‹åˆ° 3 ä¸ªé”
- æ‰€æœ‰é”éƒ½å·²æ­£å¸¸é”å®š
- æœªå‘ç°å®‰å…¨éšæ‚£

ğŸ”’ å®‰å…¨çŠ¶æ€: æ­£å¸¸
```

**è­¦å‘ŠçŠ¶æ€:**
```
âš ï¸ æ£€æµ‹å®Œæˆ - å‘ç°å®‰å…¨éšæ‚£ï¼

ğŸ“Š æ£€æµ‹ç»“æœ:
- æ€»è®¡æ£€æµ‹åˆ° 3 ä¸ªé”
- 2 ä¸ªé”å·²æ­£å¸¸é”å®š
- 1 ä¸ªé”æœªé”å®š âŒ

ğŸ”’ å®‰å…¨çŠ¶æ€: è­¦å‘Š

æœªé”å®šçš„é”:
1. padlock (ç½®ä¿¡åº¦: 0.95)

å»ºè®®: è¯·ç«‹å³æ£€æŸ¥å¹¶é”å®šæ‰€æœ‰æœªé”çš„é”ï¼
```

## ç¯å¢ƒå˜é‡é…ç½®

```bash
# é’‰é’‰æœºå™¨äººé…ç½®
DINGTALK_APP_KEY=your_app_key
DINGTALK_APP_SECRET=your_app_secret
DINGTALK_WEBHOOK_URL=your_webhook_url

# æœåŠ¡é…ç½®
HOST=0.0.0.0
PORT=8000
```

## å¯åŠ¨æœåŠ¡

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å¯åŠ¨æœåŠ¡
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

## APIæ–‡æ¡£

å¯åŠ¨æœåŠ¡åï¼Œè®¿é—®ä»¥ä¸‹åœ°å€æŸ¥çœ‹å®Œæ•´çš„APIæ–‡æ¡£ï¼š

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc
- OpenAPI JSON: http://localhost:8000/openapi.json

## æ•°æ®åº“ç»“æ„

ç³»ç»Ÿä½¿ç”¨SQLiteæ•°æ®åº“ï¼ŒåŒ…å«ä»¥ä¸‹è¡¨ï¼š

### detection_results
æ£€æµ‹ç»“æœä¸»è¡¨
- `id`: ä¸»é”®
- `image_url`: å›¾ç‰‡URL
- `image_hash`: å›¾ç‰‡å“ˆå¸Œ
- `detection_time`: æ£€æµ‹æ—¶é—´
- `locks_detected`: æ£€æµ‹åˆ°çš„é”æ•°é‡
- `unlocked_locks`: æœªé”çš„é”æ•°é‡
- `lock_positions`: é”ä½ç½®ä¿¡æ¯(JSON)
- `confidence_score`: ç½®ä¿¡åº¦
- `dingtalk_message_id`: é’‰é’‰æ¶ˆæ¯ID
- `user_id`: ç”¨æˆ·ID
- `group_id`: ç¾¤ç»„ID
- `is_safe`: æ˜¯å¦å®‰å…¨
- `created_at`: åˆ›å»ºæ—¶é—´

### lock_details
é”è¯¦ç»†ä¿¡æ¯è¡¨
- `id`: ä¸»é”®
- `detection_id`: å…³è”çš„æ£€æµ‹ç»“æœID
- `lock_type`: é”ç±»å‹
- `is_locked`: æ˜¯å¦é”å®š
- `confidence`: ç½®ä¿¡åº¦
- `position_x`: Xåæ ‡
- `position_y`: Yåæ ‡
- `width`: å®½åº¦
- `height`: é«˜åº¦

### training_records
è®­ç»ƒè®°å½•è¡¨
- `id`: ä¸»é”®
- `model_name`: æ¨¡å‹åç§°
- `training_start`: è®­ç»ƒå¼€å§‹æ—¶é—´
- `training_end`: è®­ç»ƒç»“æŸæ—¶é—´
- `epochs`: è®­ç»ƒè½®æ•°
- `batch_size`: æ‰¹æ¬¡å¤§å°
- `learning_rate`: å­¦ä¹ ç‡
- `train_loss`: è®­ç»ƒæŸå¤±
- `val_loss`: éªŒè¯æŸå¤±
- `map_score`: mAPåˆ†æ•°
- `model_path`: æ¨¡å‹è·¯å¾„
- `dataset_size`: æ•°æ®é›†å¤§å°
- `status`: çŠ¶æ€
- `created_at`: åˆ›å»ºæ—¶é—´